<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Estúdio Ultra Real IA</title>
  <style>
    body{font-family:system-ui,Arial; max-width:1050px; margin:0 auto; padding:18px; background:#0b0f17; color:#e8eefc}
    header{padding:14px 0 6px}
    h1{margin:0 0 6px 0; font-size:20px}
    .sub{opacity:.85; font-size:12px}
    .grid{display:grid; gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:#0d1322; border:1px solid #1a2440; border-radius:14px; padding:14px}
    label{display:block; font-size:12px; opacity:.9; margin:8px 0 6px}
    input, textarea, select{width:100%; border-radius:10px; border:1px solid #28345a; background:#0b0f17; color:#e8eefc; padding:10px}
    button{width:100%; border:0; border-radius:12px; background:#7c5cff; color:white; padding:11px 12px; font-weight:800; cursor:pointer; margin-top:10px}
    button.sec{background:#1f2b52}
    button:disabled{opacity:.6; cursor:not-allowed}
    .row{display:flex; gap:10px}
    .row > *{flex:1}
    .warn{background:#2a1f00; border:1px solid #5a4200; padding:10px; border-radius:12px; color:#ffd27a; font-size:12px}
    .ok{color:#7CFFB0; font-size:12px}
    .err{color:#ff8a8a; font-size:12px}
    .gallery{display:grid; grid-template-columns:repeat(2,1fr); gap:10px}
    @media(min-width:900px){.gallery{grid-template-columns:repeat(4,1fr)}}
    .thumb{border:1px solid #1a2440; border-radius:12px; overflow:hidden; background:#0b0f17}
    .thumb img,.thumb video{width:100%; display:block}
    .meta{padding:8px}
    .pill{display:inline-block; background:#162048; border:1px solid #28345a; border-radius:999px; padding:4px 8px; font-size:12px}
    .selected{outline:2px solid #7c5cff}
    a{color:#b7a7ff; text-decoration:none}
  </style>
</head>
<body>
<header>
  <h1>Estúdio Ultra Real IA — Personagem + Imagens + Vídeos</h1>
  <div class="sub">Crie um personagem fictício ultra-realista, selecione a imagem base, gere variações mantendo o mesmo rosto e baixe tudo.</div>
</header>

{% if not has_key %}
  <div class="warn">
    <b>OPENAI_API_KEY não configurada no Render.</b><br>
    Vá em Render → Service → Settings → Environment → adicione <code>OPENAI_API_KEY</code>.
  </div>
{% endif %}

<div class="grid" style="margin-top:12px">

  <div class="card">
    <h3>1) Criar personagem (rosto base)</h3>
    <label>Nome do personagem</label>
    <input id="nome" placeholder="Ex: Luna" />
    <label>Descrição ultra-realista (pele, poros, sinais, cabelo, olhos…)</label>
    <textarea id="desc" rows="5" placeholder="Ex: mulher 28 anos, pele oliva com micro sardas, poros visíveis, linhas finas ao sorrir, olhos castanhos mel, cabelo castanho ondulado..."></textarea>
    <div class="row">
      <div>
        <label>Tamanho</label>
        <select id="sizeChar">
          <option>1024x1024</option>
          <option>1536x1024</option>
          <option>1024x1536</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnCriar">Gerar personagem</button>
      </div>
    </div>
    <div id="status1" class="sub"></div>
  </div>

  <div class="card">
    <h3>2) Selecionar imagem base</h3>
    <div class="sub">Toque em “Selecionar” em uma imagem da galeria. Ela vira a base do rosto.</div>
    <div class="pill" id="baseInfo">Nenhuma imagem selecionada</div>

    <hr style="border:0;border-top:1px solid #1a2440;margin:12px 0">

    <h3>3) Gerar variação com o mesmo rosto</h3>
    <label>Nova cena / ambiente</label>
    <textarea id="cena" rows="4" placeholder="Ex: em um café em Paris ao amanhecer, luz suave, chuva leve, roupa elegante casual, fotografia cinematográfica..."></textarea>
    <div class="row">
      <div>
        <label>Tamanho</label>
        <select id="sizeVar">
          <option>1024x1024</option>
          <option>1536x1024</option>
          <option>1024x1536</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="btnVar">Gerar variação</button>
      </div>
    </div>
    <div id="status2" class="sub"></div>

    <hr style="border:0;border-top:1px solid #1a2440;margin:12px 0">

    <h3>4) Vídeo (em breve)</h3>
    <div class="sub">O endpoint de vídeo depende do acesso da sua conta. Quando estiver liberado, eu ativo aqui.</div>
    <button class="sec" id="btnVideo" disabled>Gerar vídeo (desativado)</button>
    <div id="status3" class="sub"></div>
  </div>

  <div class="card" style="grid-column:1/-1">
    <div class="row">
      <h3 style="margin:0;flex:1">Galeria (salvos)</h3>
      <button class="sec" id="btnReload" style="max-width:220px">Atualizar galeria</button>
    </div>

    <h4>Imagens</h4>
    <div id="imgs" class="gallery"></div>

    <h4 style="margin-top:18px">Vídeos</h4>
    <div id="vids" class="gallery"></div>
  </div>

</div>

<script>
let baseImage = null;
let characterId = null;

const $ = (id) => document.getElementById(id);

function setBase(name, el){
  baseImage = name;
  $("baseInfo").textContent = "Base selecionada: " + name;
  document.querySelectorAll(".thumb").forEach(t => t.classList.remove("selected"));
  if(el) el.classList.add("selected");
}

async function postForm(url, obj){
  const fd = new FormData();
  Object.entries(obj).forEach(([k,v]) => fd.append(k, v));
  const r = await fetch(url, { method:"POST", body: fd });
  const data = await r.json().catch(() => ({}));
  if(!r.ok) throw (data.detail || JSON.stringify(data));
  return data;
}

async function loadGallery(){
  const r = await fetch("/api/galeria");
  const data = await r.json();

  const imgs = $("imgs");
  imgs.innerHTML = "";
  data.images.forEach(item => {
    const d = document.createElement("div");
    d.className = "thumb";
    d.innerHTML = `
      <img src="${item.url}" alt="${item.name}" />
      <div class="meta">
        <div class="sub">${item.name}</div>
        <div class="row">
          <button class="sec" style="margin:0" data-sel="${item.name}">Selecionar</button>
          <a class="pill" href="${item.download}" download>Baixar</a>
        </div>
      </div>
    `;
    d.querySelector("button").onclick = () => setBase(item.name, d);
    imgs.appendChild(d);
  });

  const vids = $("vids");
  vids.innerHTML = "";
  data.videos.forEach(item => {
    const d = document.createElement("div");
    d.className = "thumb";
    d.innerHTML = `
      <video src="${item.url}" controls></video>
      <div class="meta">
        <div class="sub">${item.name}</div>
        <a class="pill" href="${item.download}" download>Baixar</a>
      </div>
    `;
    vids.appendChild(d);
  });
}

$("btnReload").onclick = loadGallery;

$("btnCriar").onclick = async () => {
  try{
    $("status1").textContent = "Gerando personagem...";
    const nome = $("nome").value.trim();
    const descricao = $("desc").value.trim();
    const size = $("sizeChar").value;
    const out = await postForm("/api/personagem/criar", { nome, descricao, size });
    characterId = out.character_id;
    $("status1").innerHTML = `<span class="ok">Personagem criado!</span> character_id: <b>${characterId}</b>`;
    await loadGallery();
    setBase(out.image_name);
  }catch(e){
    $("status1").innerHTML = `<span class="err">Erro:</span> ${e}`;
  }
};

$("btnVar").onclick = async () => {
  try{
    if(!characterId) throw "Crie um personagem primeiro (passo 1).";
    if(!baseImage) throw "Selecione uma imagem base na galeria.";
    $("status2").textContent = "Gerando variação...";
    const cena = $("cena").value.trim();
    const size = $("sizeVar").value;
    const out = await postForm("/api/personagem/variacao", {
      character_id: characterId,
      base_image: baseImage,
      cena,
      size
    });
    $("status2").innerHTML = `<span class="ok">Variação pronta!</span> (método: ${out.method})`;
    await loadGallery();
  }catch(e){
    $("status2").innerHTML = `<span class="err">Erro:</span> ${e}`;
  }
};

loadGallery();
</script>
</body>
</html>